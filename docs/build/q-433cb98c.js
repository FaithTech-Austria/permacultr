import{g as nt}from"./q-725317a4.js";import{p as lt}from"./q-e9d9a766.js";var tt={exports:{}};(function(E,a){(function(){var o=Math.PI,i=Math.sin,n=Math.cos,A=Math.tan,M=Math.asin,T=Math.atan2,V=Math.acos,s=o/180,H=1e3*60*60*24,O=2440588,L=2451545;function k(t){return t.valueOf()/H-.5+O}function D(t){return new Date((t+.5-O)*H)}function w(t){return k(t)-L}var N=s*23.4397;function I(t,e){return T(i(t)*n(N)-A(e)*i(N),n(t))}function z(t,e){return M(i(e)*n(N)+n(e)*i(N)*i(t))}function R(t,e,r){return T(i(t),n(t)*i(e)-A(r)*n(e))}function j(t,e,r){return M(i(e)*i(r)+n(e)*n(r)*n(t))}function q(t,e){return s*(280.16+360.9856235*t)-e}function et(t){return t<0&&(t=0),2967e-7/Math.tan(t+.00312536/(t+.08901179))}function X(t){return s*(357.5291+.98560028*t)}function $(t){var e=s*(1.9148*i(t)+.02*i(2*t)+3e-4*i(3*t)),r=s*102.9372;return t+e+r+o}function W(t){var e=X(t),r=$(e);return{dec:z(r,0),ra:I(r,0)}}var p={};p.getPosition=function(t,e,r){var h=s*-r,u=s*e,d=w(t),c=W(d),f=q(d,h)-c.ra;return{azimuth:R(f,u,c.dec),altitude:j(f,u,c.dec)}};var G=p.times=[[-.833,"sunrise","sunset"],[-.3,"sunriseEnd","sunsetStart"],[-6,"dawn","dusk"],[-12,"nauticalDawn","nauticalDusk"],[-18,"nightEnd","night"],[6,"goldenHourEnd","goldenHour"]];p.addTime=function(t,e,r){G.push([t,e,r])};var Z=9e-4;function rt(t,e){return Math.round(t-Z-e/(2*o))}function K(t,e,r){return Z+(t+e)/(2*o)+r}function Q(t,e,r){return L+t+.0053*i(e)-.0069*i(2*r)}function it(t,e,r){return V((i(t)-i(e)*i(r))/(n(e)*n(r)))}function at(t){return-2.076*Math.sqrt(t)/60}function ot(t,e,r,h,u,d,c){var f=it(t,r,h),m=K(f,e,u);return Q(m,d,c)}p.getTimes=function(t,e,r,h){h=h||0;var u=s*-r,d=s*e,c=at(h),f=w(t),m=rt(f,u),b=K(0,u,m),x=X(b),y=$(x),C=z(y,0),v=Q(b,x,y),P,B,_,g,S,J,l={solarNoon:D(v),nadir:D(v-.5)};for(P=0,B=G.length;P<B;P+=1)_=G[P],g=(_[0]+c)*s,S=ot(g,u,d,C,m,x,y),J=v-(S-v),l[_[1]]=D(J),l[_[2]]=D(S);return l};function Y(t){var e=s*(218.316+13.176396*t),r=s*(134.963+13.064993*t),h=s*(93.272+13.22935*t),u=e+s*6.289*i(r),d=s*5.128*i(h),c=385001-20905*n(r);return{ra:I(u,d),dec:z(u,d),dist:c}}p.getMoonPosition=function(t,e,r){var h=s*-r,u=s*e,d=w(t),c=Y(d),f=q(d,h)-c.ra,m=j(f,u,c.dec),b=T(i(f),A(u)*n(c.dec)-i(c.dec)*n(f));return m=m+et(m),{azimuth:R(f,u,c.dec),altitude:m,distance:c.dist,parallacticAngle:b}},p.getMoonIllumination=function(t){var e=w(t||new Date),r=W(e),h=Y(e),u=149598e3,d=V(i(r.dec)*i(h.dec)+n(r.dec)*n(h.dec)*n(r.ra-h.ra)),c=T(u*i(d),h.dist-u*n(d)),f=T(n(r.dec)*i(r.ra-h.ra),i(r.dec)*n(h.dec)-n(r.dec)*i(h.dec)*n(r.ra-h.ra));return{fraction:(1+n(c))/2,phase:.5+.5*c*(f<0?-1:1)/Math.PI,angle:f}};function F(t,e){return new Date(t.valueOf()+e*H/24)}p.getMoonTimes=function(t,e,r,h){var u=new Date(t);h?u.setUTCHours(0,0,0,0):u.setHours(0,0,0,0);for(var d=.133*s,c=p.getMoonPosition(u,e,r).altitude-d,f,m,b,x,y,C,v,P,B,_,g,S,J,l=1;l<=24&&(f=p.getMoonPosition(F(u,l),e,r).altitude-d,m=p.getMoonPosition(F(u,l+1),e,r).altitude-d,y=(c+m)/2-f,C=(m-c)/2,v=-C/(2*y),P=(y*v+C)*v+f,B=C*C-4*y*f,_=0,B>=0&&(J=Math.sqrt(B)/(Math.abs(y)*2),g=v-J,S=v+J,Math.abs(g)<=1&&_++,Math.abs(S)<=1&&_++,g<-1&&(g=S)),_===1?c<0?b=l+g:x=l+g:_===2&&(b=l+(P<0?S:g),x=l+(P<0?g:S)),!(b&&x));l+=2)c=m;var U={};return b&&(U.rise=F(u,b)),x&&(U.set=F(u,x)),!b&&!x&&(U[P>0?"alwaysUp":"alwaysDown"]=!0),U},E.exports=p})()})(tt);var st=tt.exports;const ut=nt(st);class ct{constructor(a){this.date=a,this.id="building-shadows",this.type="custom",this.renderingMode="3d",this.opacity=.5}onAdd(a,o){this.map=a;const i=`
      uniform mat4 u_matrix;
      uniform float u_height_factor;

      uniform float u_altitude;
      uniform float u_azimuth;

      attribute vec2 a_pos;
      attribute vec4 a_normal_ed;

      attribute lowp vec2 a_base;
      attribute lowp vec2 a_height;

      void main() {
          float base = max(0.0, a_base.x);
          float height = max(0.0, a_height.x);
          float t = mod(a_normal_ed.x, 2.0);

          vec4 pos = vec4(a_pos, t > 0.0 ? height : base, 1);

          float len = pos.z * u_height_factor / tan(u_altitude);
          pos.x += cos(u_azimuth) * len;
          pos.y += sin(u_azimuth) * len;
          pos.z = 0.0;

          gl_Position = u_matrix * pos;
      }
      `,n=`
      void main() {
          gl_FragColor = vec4(0.3, 0.3, 0.3, 1.0);
      }
      `,A=o.createShader(o.VERTEX_SHADER);o.shaderSource(A,i),o.compileShader(A);const M=o.createShader(o.FRAGMENT_SHADER);o.shaderSource(M,n),o.compileShader(M),this.program=o.createProgram(),o.attachShader(this.program,A),o.attachShader(this.program,M),o.linkProgram(this.program),o.validateProgram(this.program),this.uMatrix=o.getUniformLocation(this.program,"u_matrix"),this.uHeightFactor=o.getUniformLocation(this.program,"u_height_factor"),this.uAltitude=o.getUniformLocation(this.program,"u_altitude"),this.uAzimuth=o.getUniformLocation(this.program,"u_azimuth"),this.aPos=o.getAttribLocation(this.program,"a_pos"),this.aNormal=o.getAttribLocation(this.program,"a_normal_ed"),this.aBase=o.getAttribLocation(this.program,"a_base"),this.aHeight=o.getAttribLocation(this.program,"a_height")}render(a,o){a.useProgram(this.program);const i=this.map.style.sourceCaches.openmaptiles,n=i.getVisibleCoordinates().reverse(),A=map.getLayer("3d-buildings"),M=this.map.painter.context,{lng:T,lat:V}=this.map.getCenter(),s=ut.getPosition(this.date,V,T);a.uniform1f(this.uAltitude,s.altitude),a.uniform1f(this.uAzimuth,s.azimuth+3*Math.PI/2),map.setLight({anchor:"map",position:[1.5,180+s.azimuth*180/Math.PI,90-s.altitude*180/Math.PI],"position-transition":{duration:0},color:`hsl(20, ${50*Math.cos(s.altitude)}%, ${200*Math.sin(s.altitude)}%)`},{duration:0}),this.opacity=Math.sin(Math.max(s.altitude,0))*.9;for(const H of n){const O=i.getTile(H),L=O.getBucket(A);if(!L)continue;const[k,D]=L.programConfigurations.programConfigurations["3d-buildings"]._buffers;a.uniformMatrix4fv(this.uMatrix,!1,H.posMatrix),a.uniform1f(this.uHeightFactor,Math.pow(2,H.overscaledZ)/O.tileSize/8);for(const w of L.segments.get()){const N=M.currentNumAttributes||0,I=2;for(let R=I;R<N;R++)a.disableVertexAttribArray(R);const z=w.vertexOffset||0;a.enableVertexAttribArray(this.aPos),a.enableVertexAttribArray(this.aNormal),a.enableVertexAttribArray(this.aHeight),a.enableVertexAttribArray(this.aBase),L.layoutVertexBuffer.bind(),a.vertexAttribPointer(this.aPos,2,a.SHORT,!1,12,12*z),a.vertexAttribPointer(this.aNormal,4,a.SHORT,!1,12,4+12*z),k.bind(),a.vertexAttribPointer(this.aHeight,1,a.FLOAT,!1,4,4*z),D.bind(),a.vertexAttribPointer(this.aBase,1,a.FLOAT,!1,4,4*z),L.indexBuffer.bind(),M.currentNumAttributes=I,a.drawElements(a.TRIANGLES,w.primitiveLength*3,a.UNSIGNED_SHORT,w.primitiveOffset*6)}}}}const dt=(E,a)=>{E.removeLayer("Building"),E.addLayer({id:"3d-buildings",source:"openmaptiles","source-layer":"building",type:"fill-extrusion",minzoom:14,paint:{"fill-extrusion-color":"#ddd","fill-extrusion-height":["number",["get","height"],5],"fill-extrusion-base":["number",["get","min_height"],0],"fill-extrusion-opacity":1}},"River labels"),E.addLayer(new ct(a),"3d-buildings")};export{lt as _hW,dt as s_rxVfrhmRXzc};
