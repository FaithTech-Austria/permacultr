import{p as Se}from"./q-7b203fc8.js";function y(){return y=Object.assign?Object.assign.bind():function(s){for(var t=1;t<arguments.length;t++){var e=arguments[t];for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(s[i]=e[i])}return s},y.apply(this,arguments)}function f(s,t=9){const e=Math.pow(10,t);return Math.round(s*e)/e}const St=(s,t)=>{const{x:e,y:i}=s,{x:n,y:o}=t,r=n-e,a=o-i;return Math.sqrt(a*a+r*r)};class x{constructor({name:t,callback:e,unregister:i,register:n}){this.name=void 0,this.callback=void 0,this.registered=!1,this.register=void 0,this.unregister=void 0,this.name=t,this.register=()=>{this.registered||(this.registered=!0,n(e))},this.unregister=()=>{this.register&&(this.registered=!1,i(e))},this.callback=e}}class bt{constructor(t){this._minPixelDragDistance=void 0,this._lastDrawEvent=void 0,this._coordinatePrecision=void 0,this._heldKeys=new Set,this._listeners=[],this._dragState="not-dragging",this._currentModeCallbacks=void 0,this._minPixelDragDistance=typeof t.minPixelDragDistance=="number"?t.minPixelDragDistance:8,this._coordinatePrecision=typeof t.coordinatePrecision=="number"?t.coordinatePrecision:9,this._listeners=[new x({name:"pointerdown",callback:e=>{if(!e.isPrimary)return;const i=this.getDrawEventFromEvent(e);i&&(this._dragState="pre-dragging",this._lastDrawEvent=i)},register:e=>{this.getMapContainer().addEventListener("pointerdown",e)},unregister:e=>{this.getMapContainer().removeEventListener("pointerdown",e)}}),new x({name:"pointermove",callback:e=>{if(!this._currentModeCallbacks||!e.isPrimary)return;e.preventDefault();const i=this.getDrawEventFromEvent(e);if(i)if(this._dragState==="not-dragging")this._currentModeCallbacks.onMouseMove(i),this._lastDrawEvent=i;else if(this._dragState==="pre-dragging"){if(!this._lastDrawEvent)return;const n={x:this._lastDrawEvent.containerX,y:this._lastDrawEvent.containerY},o={x:i.containerX,y:i.containerY};if(this._currentModeCallbacks.getState()==="drawing"&&St(n,o)<this._minPixelDragDistance)return;this._dragState="dragging",this._currentModeCallbacks.onDragStart(i,r=>{this.setDraggability.bind(this)(r)})}else this._dragState==="dragging"&&this._currentModeCallbacks.onDrag(i,n=>{this.setDraggability.bind(this)(n)})},register:e=>{this.getMapContainer().addEventListener("pointermove",e)},unregister:e=>{this.getMapContainer().removeEventListener("pointermove",e)}}),new x({name:"contextmenu",callback:e=>{if(this._currentModeCallbacks&&(e.preventDefault(),this._dragState==="not-dragging"||this._dragState==="pre-dragging")){const i=this.getDrawEventFromEvent(e);if(!i)return;i.button!=="neither"&&this._currentModeCallbacks.onClick(i)}},register:e=>{this.getMapContainer().addEventListener("contextmenu",e)},unregister:e=>{this.getMapContainer().removeEventListener("contextmenu",e)}}),new x({name:"pointerup",callback:e=>{if(!this._currentModeCallbacks||!e.isPrimary)return;const i=this.getDrawEventFromEvent(e);i&&(this._dragState==="dragging"?this._currentModeCallbacks.onDragEnd(i,n=>{this.setDraggability.bind(this)(n)}):this._dragState!=="not-dragging"&&this._dragState!=="pre-dragging"||this._currentModeCallbacks.onClick(i),this._dragState="not-dragging",this.setDraggability(!0))},register:e=>{this.getMapContainer().addEventListener("pointerup",e)},unregister:e=>{this.getMapContainer().removeEventListener("pointerup",e)}}),new x({name:"keyup",callback:e=>{this._currentModeCallbacks&&(this._heldKeys.delete(e.key),this._currentModeCallbacks.onKeyUp({key:e.key,heldKeys:Array.from(this._heldKeys),preventDefault:()=>e.preventDefault()}))},register:e=>{this.getMapContainer().addEventListener("keyup",e)},unregister:e=>{this.getMapContainer().removeEventListener("keyup",e)}}),new x({name:"keydown",callback:e=>{this._currentModeCallbacks&&(this._heldKeys.add(e.key),this._currentModeCallbacks.onKeyDown({key:e.key,heldKeys:Array.from(this._heldKeys),preventDefault:()=>e.preventDefault()}))},register:e=>{this.getMapContainer().addEventListener("keydown",e)},unregister:e=>{this.getMapContainer().removeEventListener("keydown",e)}})]}getButton(t){return t.button===-1?"neither":t.button===0?"left":t.button===1?"middle":t.button===2?"right":"neither"}getContainerXYPosition(t){const e=this.getMapContainer(),{left:i,top:n}=e.getBoundingClientRect();return{containerX:t.clientX-i,containerY:t.clientY-n}}getDrawEventFromEvent(t){const e=this.getLngLatFromEvent(t);if(!e)return null;const{lng:i,lat:n}=e,{containerX:o,containerY:r}=this.getContainerXYPosition(t),a=this.getButton(t),l=Array.from(this._heldKeys);return{lng:f(i,this._coordinatePrecision),lat:f(n,this._coordinatePrecision),containerX:o,containerY:r,button:a,heldKeys:l}}register(t){this._currentModeCallbacks=t,this._listeners.forEach(e=>{e.register()})}unregister(){this._listeners.forEach(t=>{t.unregister()}),this.clear()}}class Yt extends bt{constructor(t){super(t),this._nextRender=void 0,this._map=void 0,this._container=void 0,this._rendered=!1,this.changedIds={deletion:!1,points:!1,linestrings:!1,polygons:!1,styling:!1},this._map=t.map,this._container=this._map.getContainer()}clearLayers(){this._rendered&&(["point","linestring","polygon"].forEach(t=>{const e=`td-${t.toLowerCase()}`;this._map.removeLayer(e),t==="polygon"&&this._map.removeLayer(e+"-outline"),this._map.removeSource(e)}),this._rendered=!1)}_addGeoJSONSource(t,e){this._map.addSource(t,{type:"geojson",data:{type:"FeatureCollection",features:e},tolerance:0})}_addFillLayer(t){return this._map.addLayer({id:t,source:t,type:"fill",paint:{"fill-color":["get","polygonFillColor"],"fill-opacity":["get","polygonFillOpacity"]}})}_addFillOutlineLayer(t,e){const i=this._map.addLayer({id:t+"-outline",source:t,type:"line",paint:{"line-width":["get","polygonOutlineWidth"],"line-color":["get","polygonOutlineColor"]}});return e&&this._map.moveLayer(t,e),i}_addLineLayer(t,e){const i=this._map.addLayer({id:t,source:t,type:"line",paint:{"line-width":["get","lineStringWidth"],"line-color":["get","lineStringColor"]}});return e&&this._map.moveLayer(t,e),i}_addPointLayer(t,e){const i=this._map.addLayer({id:t,source:t,type:"circle",paint:{"circle-stroke-color":["get","pointOutlineColor"],"circle-stroke-width":["get","pointOutlineWidth"],"circle-radius":["get","pointWidth"],"circle-color":["get","pointColor"]}});return e&&this._map.moveLayer(t,e),i}_addLayer(t,e,i){e==="Point"&&this._addPointLayer(t,i),e==="LineString"&&this._addLineLayer(t,i),e==="Polygon"&&(this._addFillLayer(t),this._addFillOutlineLayer(t,i))}_addGeoJSONLayer(t,e){const i=`td-${t.toLowerCase()}`;return this._addGeoJSONSource(i,e),this._addLayer(i,t),i}_setGeoJSONLayerData(t,e){const i=`td-${t.toLowerCase()}`;return this._map.getSource(i).setData({type:"FeatureCollection",features:e}),i}getEmptyGeometries(){return{points:[],linestrings:[],polygons:[]}}updateChangedIds(t){[...t.updated,...t.created].forEach(e=>{e.geometry.type==="Point"?this.changedIds.points=!0:e.geometry.type==="LineString"?this.changedIds.linestrings=!0:e.geometry.type==="Polygon"&&(this.changedIds.polygons=!0)}),t.deletedIds.length>0&&(this.changedIds.deletion=!0),t.created.length===0&&t.updated.length===0&&t.deletedIds.length===0&&(this.changedIds.styling=!0)}getLngLatFromEvent(t){const{left:e,top:i}=this.getMapContainer().getBoundingClientRect();return this.unproject(t.clientX-e,t.clientY-i)}getMapContainer(){return this._container}setDraggability(t){t?(this._map.dragRotate.enable(),this._map.dragPan.enable()):(this._map.dragRotate.disable(),this._map.dragPan.disable())}project(t,e){const{x:i,y:n}=this._map.project({lng:t,lat:e});return{x:i,y:n}}unproject(t,e){const{lng:i,lat:n}=this._map.unproject({x:t,y:e});return{lng:i,lat:n}}setCursor(t){const e=this._map.getCanvas();t==="unset"?e.style.removeProperty("cursor"):e.style.cursor=t}setDoubleClickToZoom(t){t?this._map.doubleClickZoom.enable():this._map.doubleClickZoom.disable()}render(t,e){this.updateChangedIds(t),this._nextRender&&cancelAnimationFrame(this._nextRender),this._nextRender=requestAnimationFrame(()=>{const i=[...t.created,...t.updated,...t.unchanged],n=this.getEmptyGeometries();for(let l=0;l<i.length;l++){const h=i[l];Object.keys(e).forEach(c=>{const{properties:d}=h;if(d.mode!==c)return;const g=e[c](h);h.geometry.type==="Point"?(d.pointColor=g.pointColor,d.pointOutlineColor=g.pointOutlineColor,d.pointOutlineWidth=g.pointOutlineWidth,d.pointWidth=g.pointWidth,n.points.push(h)):h.geometry.type==="LineString"?(d.lineStringColor=g.lineStringColor,d.lineStringWidth=g.lineStringWidth,n.linestrings.push(h)):h.geometry.type==="Polygon"&&(d.polygonFillColor=g.polygonFillColor,d.polygonFillOpacity=g.polygonFillOpacity,d.polygonOutlineColor=g.polygonOutlineColor,d.polygonOutlineWidth=g.polygonOutlineWidth,n.polygons.push(h))})}const{points:o,linestrings:r,polygons:a}=n;if(this._rendered){const l=this.changedIds.deletion||this.changedIds.styling,h=l||this.changedIds.linestrings,c=l||this.changedIds.polygons;let d;(l||this.changedIds.points)&&(d=this._setGeoJSONLayerData("Point",o)),h&&this._setGeoJSONLayerData("LineString",r),c&&this._setGeoJSONLayerData("Polygon",a),d&&this._map.moveLayer(d)}else this._addGeoJSONLayer("Point",o),this._addGeoJSONLayer("LineString",r),this._addGeoJSONLayer("Polygon",a),this._rendered=!0;this.changedIds={points:!1,linestrings:!1,polygons:!1,deletion:!1,styling:!1}})}clear(){this._currentModeCallbacks&&(this._currentModeCallbacks.onClear(),this.clearLayers())}}class Nt extends bt{constructor(t){super(t),this.mapboxglAdapter=void 0,this.mapboxglAdapter=new Yt(t)}register(t){this.mapboxglAdapter.register(t)}unregister(){this.mapboxglAdapter.unregister()}getLngLatFromEvent(t){return this.mapboxglAdapter.getLngLatFromEvent(t)}getMapContainer(){return this.mapboxglAdapter.getMapContainer()}setDraggability(t){this.mapboxglAdapter.setDraggability(t)}project(t,e){return this.mapboxglAdapter.project(t,e)}unproject(t,e){return this.mapboxglAdapter.unproject(t,e)}setCursor(t){this.mapboxglAdapter.setCursor(t)}setDoubleClickToZoom(t){this.mapboxglAdapter.setDoubleClickToZoom(t)}render(t,e){this.mapboxglAdapter.render(t,e)}clear(){this.mapboxglAdapter.clear()}}let Ut=0;const _=typeof navigator<"u"&&navigator.userAgent!==void 0?navigator.userAgent.toLowerCase():"";_.includes("firefox"),_.includes("safari")&&!_.includes("chrom")&&(_.includes("version/15.4")||/cpu (os|iphone os) 15_4 like mac os x/.test(_)),_.includes("webkit")&&_.includes("edge"),_.includes("macintosh");typeof WorkerGlobalScope<"u"&&typeof OffscreenCanvas<"u"&&self instanceof WorkerGlobalScope;(function(){let s=!1;try{const t=Object.defineProperty({},"passive",{get:function(){s=!0}});window.addEventListener("_",null,t),window.removeEventListener("_",null,t)}catch{}})();var Dt=class{constructor(s){this.type=s,this.target=null}preventDefault(){this.defaultPrevented=!0}stopPropagation(){this.propagationStopped=!0}},Vt=class{constructor(){this.disposed=!1}dispose(){this.disposed||(this.disposed=!0,this.disposeInternal())}disposeInternal(){}};function lt(){}function It(s){for(const t in s)delete s[t]}var Rt=class extends Vt{constructor(s){super(),this.eventTarget_=s,this.pendingRemovals_=null,this.dispatching_=null,this.listeners_=null}addEventListener(s,t){if(!s||!t)return;const e=this.listeners_||(this.listeners_={}),i=e[s]||(e[s]=[]);i.includes(t)||i.push(t)}dispatchEvent(s){const t=typeof s=="string",e=t?s:s.type,i=this.listeners_&&this.listeners_[e];if(!i)return;const n=t?new Dt(s):s;n.target||(n.target=this.eventTarget_||this);const o=this.dispatching_||(this.dispatching_={}),r=this.pendingRemovals_||(this.pendingRemovals_={});let a;e in o||(o[e]=0,r[e]=0),++o[e];for(let l=0,h=i.length;l<h;++l)if(a="handleEvent"in i[l]?i[l].handleEvent(n):i[l].call(this,n),a===!1||n.propagationStopped){a=!1;break}if(--o[e]==0){let l=r[e];for(delete r[e];l--;)this.removeEventListener(e,lt);delete o[e]}return a}disposeInternal(){this.listeners_&&It(this.listeners_)}getListeners(s){return this.listeners_&&this.listeners_[s]||void 0}hasListener(s){return!!this.listeners_&&(s?s in this.listeners_:Object.keys(this.listeners_).length>0)}removeEventListener(s,t){const e=this.listeners_&&this.listeners_[s];if(e){const i=e.indexOf(t);i!==-1&&(this.pendingRemovals_&&s in this.pendingRemovals_?(e[i]=lt,++this.pendingRemovals_[s]):(e.splice(i,1),e.length===0&&delete this.listeners_[s]))}}};function nt(s,t,e,i,n){if(i&&i!==s&&(e=e.bind(i)),n){const r=e;e=function(){s.removeEventListener(t,e),r.apply(this,arguments)}}const o={target:s,type:t,listener:e};return s.addEventListener(t,e),o}function ht(s,t,e,i){return nt(s,t,e,i,!0)}function dt(s){s&&s.target&&(s.target.removeEventListener(s.type,s.listener),It(s))}var Kt=class extends Rt{constructor(){super(),this.on=this.onInternal,this.once=this.onceInternal,this.un=this.unInternal,this.revision_=0}changed(){++this.revision_,this.dispatchEvent("change")}getRevision(){return this.revision_}onInternal(s,t){if(Array.isArray(s)){const e=s.length,i=new Array(e);for(let n=0;n<e;++n)i[n]=nt(this,s[n],t);return i}return nt(this,s,t)}onceInternal(s,t){let e;if(Array.isArray(s)){const i=s.length;e=new Array(i);for(let n=0;n<i;++n)e[n]=ht(this,s[n],t)}else e=ht(this,s,t);return t.ol_key=e,e}unInternal(s,t){const e=t.ol_key;if(e)(function(i){if(Array.isArray(i))for(let n=0,o=i.length;n<o;++n)dt(i[n]);else dt(i)})(e);else if(Array.isArray(s))for(let i=0,n=s.length;i<n;++i)this.removeEventListener(s[i],t);else this.removeEventListener(s,t)}};class ct extends Dt{constructor(t,e,i){super(t),this.key=e,this.oldValue=i}}new class extends Kt{constructor(s){super(),this.ol_uid||(this.ol_uid=String(++Ut)),this.values_=null,s!==void 0&&this.setProperties(s)}get(s){let t;return this.values_&&this.values_.hasOwnProperty(s)&&(t=this.values_[s]),t}getKeys(){return this.values_&&Object.keys(this.values_)||[]}getProperties(){return this.values_&&Object.assign({},this.values_)||{}}hasProperties(){return!!this.values_}notify(s,t){let e;e=`change:${s}`,this.hasListener(e)&&this.dispatchEvent(new ct(e,s,t)),e="propertychange",this.hasListener(e)&&this.dispatchEvent(new ct(e,s,t))}addChangeListener(s,t){this.addEventListener(`change:${s}`,t)}removeChangeListener(s,t){this.removeEventListener(`change:${s}`,t)}set(s,t,e){const i=this.values_||(this.values_={});if(e)i[s]=t;else{const n=i[s];i[s]=t,n!==t&&this.notify(s,n)}}setProperties(s,t){for(const e in s)this.set(e,s[e],t)}applyProperties(s){s.values_&&Object.assign(this.values_||(this.values_={}),s.values_)}unset(s,t){if(this.values_&&s in this.values_){const e=this.values_[s];delete this.values_[s],function(i){let n;for(n in i)return!1;return!n}(this.values_)&&(this.values_=null),t||this.notify(s,e)}}};const Tt={radians:6370997/(2*Math.PI),degrees:2*Math.PI*6370997/360,ft:.3048,m:1,"us-ft":1200/3937};var kt=class{constructor(s){this.code_=s.code,this.units_=s.units,this.extent_=s.extent!==void 0?s.extent:null,this.worldExtent_=s.worldExtent!==void 0?s.worldExtent:null,this.axisOrientation_=s.axisOrientation!==void 0?s.axisOrientation:"enu",this.global_=s.global!==void 0&&s.global,this.canWrapX_=!(!this.global_||!this.extent_),this.getPointResolutionFunc_=s.getPointResolution,this.defaultTileGrid_=null,this.metersPerUnit_=s.metersPerUnit}canWrapX(){return this.canWrapX_}getCode(){return this.code_}getExtent(){return this.extent_}getUnits(){return this.units_}getMetersPerUnit(){return this.metersPerUnit_||Tt[this.units_]}getWorldExtent(){return this.worldExtent_}getAxisOrientation(){return this.axisOrientation_}isGlobal(){return this.global_}setGlobal(s){this.global_=s,this.canWrapX_=!(!s||!this.extent_)}getDefaultTileGrid(){return this.defaultTileGrid_}setDefaultTileGrid(s){this.defaultTileGrid_=s}setExtent(s){this.extent_=s,this.canWrapX_=!(!this.global_||!s)}setWorldExtent(s){this.worldExtent_=s}setGetPointResolution(s){this.getPointResolutionFunc_=s}getPointResolutionFunc(){return this.getPointResolutionFunc_}};const F=6378137,S=Math.PI*F,Ht=[-S,-S,S,S],$t=[-180,-85,180,85],V=F*Math.log(Math.tan(Math.PI/2));class M extends kt{constructor(t){super({code:t,units:"m",extent:Ht,global:!0,worldExtent:$t,getPointResolution:function(e,i){return e/Math.cosh(i[1]/F)}})}}const gt=[new M("EPSG:3857"),new M("EPSG:102100"),new M("EPSG:102113"),new M("EPSG:900913"),new M("http://www.opengis.net/def/crs/EPSG/0/3857"),new M("http://www.opengis.net/gml/srs/epsg.xml#3857")],ut=[-180,-90,180,90],zt=6378137*Math.PI/180;class C extends kt{constructor(t,e){super({code:t,units:"degrees",extent:ut,axisOrientation:e,global:!0,metersPerUnit:zt,worldExtent:ut})}}const pt=[new C("CRS:84"),new C("EPSG:4326","neu"),new C("urn:ogc:def:crs:OGC:1.3:CRS84"),new C("urn:ogc:def:crs:OGC:2:84"),new C("http://www.opengis.net/def/crs/OGC/1.3/CRS84"),new C("http://www.opengis.net/gml/srs/epsg.xml#4326","neu"),new C("http://www.opengis.net/def/crs/EPSG/0/4326","neu")];let Q={};function $(s,t,e){const i=s.getCode(),n=t.getCode();i in Q||(Q[i]={}),Q[i][n]=e}function Ot(s,t,e){if(t!==void 0)for(let i=0,n=s.length;i<n;++i)t[i]=s[i];else t=s.slice();return t}function Zt(s){s.getCode(),$(s,s,Ot)}function yt(s){(function(t){t.forEach(Zt)})(s),s.forEach(function(t){s.forEach(function(e){t!==e&&$(t,e,Ot)})})}var ft,mt,vt;yt(gt),yt(pt),ft=gt,mt=function(s,t,e){const i=s.length;e=e>1?e:2,t===void 0&&(t=e>2?s.slice():new Array(i));for(let n=0;n<i;n+=e){t[n]=S*s[n]/180;let o=F*Math.log(Math.tan(Math.PI*(+s[n+1]+90)/360));o>V?o=V:o<-V&&(o=-V),t[n+1]=o}return t},vt=function(s,t,e){const i=s.length;e=e>1?e:2,t===void 0&&(t=e>2?s.slice():new Array(i));for(let n=0;n<i;n+=e)t[n]=180*s[n]/S,t[n+1]=360*Math.atan(Math.exp(s[n+1]/F))/Math.PI-90;return t},pt.forEach(function(s){ft.forEach(function(t){$(s,t,mt),$(t,s,vt)})});const ot="selected",H="midPoint",_t="closingPoint";function tt(s){return!!(s&&typeof s=="object"&&s!==null&&!Array.isArray(s))}function Pt(s){if(!function(t){return typeof t=="number"&&!isNaN(new Date(t).valueOf())}(s))throw new Error("updatedAt and createdAt are not valid timestamps");return!0}var b;(function(s){s.Drawing="drawing",s.Select="select",s.Static="static",s.Render="render"})(b||(b={}));class Z{get state(){return this._state}set state(t){throw new Error("Please use the modes lifecycle methods")}get styles(){return this._styles}set styles(t){if(typeof t!="object")throw new Error("Styling must be an object");this.onStyleChange([],"styling"),this._styles=t}registerBehaviors(t){}constructor(t){this._state=void 0,this._styles=void 0,this.behaviors=[],this.pointerDistance=void 0,this.coordinatePrecision=void 0,this.onStyleChange=void 0,this.store=void 0,this.setDoubleClickToZoom=void 0,this.unproject=void 0,this.project=void 0,this.setCursor=void 0,this.type=b.Drawing,this.mode="base",this._state="unregistered",this._styles=t&&t.styles?y({},t.styles):{},this.pointerDistance=t&&t.pointerDistance||40,this.coordinatePrecision=t&&t.coordinatePrecision||9}setDrawing(){if(this._state!=="started")throw new Error("Mode must be unregistered or stopped to start");this._state="drawing"}setStarted(){if(this._state!=="stopped"&&this._state!=="registered"&&this._state!=="drawing")throw new Error("Mode must be unregistered or stopped to start");this._state="started",this.setDoubleClickToZoom(!1)}setStopped(){if(this._state!=="started")throw new Error("Mode must be started to be stopped");this._state="stopped",this.setDoubleClickToZoom(!0)}register(t){if(this._state!=="unregistered")throw new Error("Can not register unless mode is unregistered");this._state="registered",this.store=t.store,this.store.registerOnChange(t.onChange),this.setDoubleClickToZoom=t.setDoubleClickToZoom,this.project=t.project,this.unproject=t.unproject,this.onSelect=t.onSelect,this.onDeselect=t.onDeselect,this.setCursor=t.setCursor,this.onStyleChange=t.onChange,this.onFinish=t.onFinish,this.registerBehaviors({mode:t.mode,store:this.store,project:this.project,unproject:this.unproject,pointerDistance:this.pointerDistance,coordinatePrecision:this.coordinatePrecision})}validateFeature(t){return function(e){let i;if(tt(e))if(e.id)if(typeof e.id!="string"||e.id.length!==36)i="Feature must have UUID4 id";else if(tt(e.geometry))if(tt(e.properties))if(typeof e.geometry.type=="string"&&["Polygon","LineString","Point"].includes(e.geometry.type))if(Array.isArray(e.geometry.coordinates)){if(!e.properties.mode||typeof e.properties.mode!="string")throw new Error("Feature does not have a valid mode property")}else i="Feature coordinates is not an array";else i="Feature is not Point, LineString or Polygon";else i="Feature has no properties";else i="Feature has no geometry";else i="Feature has no id";else i="Feature is not object";if(i)throw new Error(i);return!0}(t)}onFinish(t){}onDeselect(t){}onSelect(t){}onKeyDown(t){}onKeyUp(t){}onMouseMove(t){}onClick(t){}onDragStart(t,e){}onDrag(t,e){}onDragEnd(t,e){}getHexColorStylingValue(t,e,i){return this.getStylingValue(t,e,i)}getNumericStylingValue(t,e,i){return this.getStylingValue(t,e,i)}getStylingValue(t,e,i){return t===void 0?e:typeof t=="function"?t(i):t}}function Ft(s,t){const e=h=>h*Math.PI/180,i=e(s[1]),n=e(s[0]),o=e(t[1]),r=o-i,a=e(t[0])-n,l=Math.sin(r/2)*Math.sin(r/2)+Math.cos(i)*Math.cos(o)*Math.sin(a/2)*Math.sin(a/2);return 2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l))*6371e3/1e3}function P(s){return s%360*Math.PI/180}function rt(s){return s%(2*Math.PI)*180/Math.PI}function Jt(s,t,e){const i=P(s[0]),n=P(s[1]),o=P(e),r=function(l){return l/6371.0088}(t),a=Math.asin(Math.sin(n)*Math.cos(r)+Math.cos(n)*Math.sin(r)*Math.cos(o));return[rt(i+Math.atan2(Math.sin(o)*Math.sin(r)*Math.cos(n),Math.cos(r)-Math.sin(n)*Math.sin(a))),rt(a)]}function Ct(s){const{center:t,radiusKilometers:e,coordinatePrecision:i}=s,n=s.steps?s.steps:64,o=[];for(let r=0;r<n;r++){const a=Jt(t,e,-360*r/n);o.push([f(a[0],i),f(a[1],i)])}return o.push(o[0]),{type:"Feature",geometry:{type:"Polygon",coordinates:[o]},properties:{}}}function Lt(s){let t;if(s.geometry.type==="Polygon")t=s.geometry.coordinates;else{if(s.geometry.type!=="LineString")throw new Error("Self intersects only accepts Polygons and LineStrings");t=[s.geometry.coordinates]}const e=[];for(let o=0;o<t.length;o++)for(let r=0;r<t[o].length-1;r++)for(let a=0;a<t.length;a++)for(let l=0;l<t[a].length-1;l++)n(o,r,a,l);return e.length>0;function i(o){return o<0||o>1}function n(o,r,a,l){const h=t[o][r],c=t[o][r+1],d=t[a][l],g=t[a][l+1],u=function(L,J,D,B){if(R(L,D)||R(L,B)||R(J,D)||R(B,D))return null;const W=L[0],G=L[1],A=J[0],j=J[1],X=D[0],Y=D[1],N=B[0],U=B[1],q=(W-A)*(Y-U)-(G-j)*(X-N);return q===0?null:[((W*j-G*A)*(X-N)-(W-A)*(X*U-Y*N))/q,((W*j-G*A)*(Y-U)-(G-j)*(X*U-Y*N))/q]}(h,c,d,g);if(u===null)return;let v,p;v=c[0]!==h[0]?(u[0]-h[0])/(c[0]-h[0]):(u[1]-h[1])/(c[1]-h[1]),p=g[0]!==d[0]?(u[0]-d[0])/(g[0]-d[0]):(u[1]-d[1])/(g[1]-d[1]),i(v)||i(p)||(u.toString(),e.push(u))}}function R(s,t){return s[0]===t[0]&&s[1]===t[1]}function qt(s,t){return s.length===2&&typeof s[0]=="number"&&typeof s[1]=="number"&&s[0]!==1/0&&s[1]!==1/0&&(i=s[0])>=-180&&i<=180&&(e=s[1])>=-90&&e<=90&&xt(s[0])<=t&&xt(s[1])<=t;var e,i}function xt(s){let t=1,e=0;for(;Math.round(s*t)/t!==s;)t*=10,e++;return e}function Bt(s,t){return s.geometry.type==="Polygon"&&s.geometry.coordinates.length===1&&s.geometry.coordinates[0].length>=4&&s.geometry.coordinates[0].every(n=>qt(n,t))&&(e=s.geometry.coordinates[0][0])[0]===(i=s.geometry.coordinates[0][s.geometry.coordinates[0].length-1])[0]&&e[1]===i[1];var e,i}function Qt(s,t){return Bt(s,t)&&!Lt(s)}class te extends Z{constructor(t){if(super(t),this.mode="circle",this.center=void 0,this.clickCount=0,this.currentCircleId=void 0,this.keyEvents=void 0,(t==null?void 0:t.keyEvents)===null)this.keyEvents={cancel:null,finish:null};else{const e={cancel:"Escape",finish:"Enter"};this.keyEvents=t&&t.keyEvents?y({},e,t.keyEvents):e}}close(){if(!this.currentCircleId)return;const t=this.currentCircleId;this.center=void 0,this.currentCircleId=void 0,this.clickCount=0,this.state==="drawing"&&this.setStarted(),this.onFinish(t)}start(){this.setStarted(),this.setCursor("crosshair")}stop(){this.cleanUp(),this.setStopped(),this.setCursor("unset")}onClick(t){if(this.clickCount===0){this.center=[t.lng,t.lat];const e=Ct({center:this.center,radiusKilometers:1e-5,coordinatePrecision:this.coordinatePrecision}),[i]=this.store.create([{geometry:e.geometry,properties:{mode:this.mode}}]);this.currentCircleId=i,this.clickCount++,this.setDrawing()}else this.close()}onMouseMove(t){if(this.clickCount===1&&this.center&&this.currentCircleId){const e=Ft(this.center,[t.lng,t.lat]),i=Ct({center:this.center,radiusKilometers:e,coordinatePrecision:this.coordinatePrecision});this.store.updateGeometry([{id:this.currentCircleId,geometry:i.geometry}])}}onKeyDown(){}onKeyUp(t){t.key===this.keyEvents.cancel?this.cleanUp():t.key===this.keyEvents.finish&&this.close()}onDragStart(){}onDrag(){}onDragEnd(){}cleanUp(){try{this.currentCircleId&&this.store.delete([this.currentCircleId])}catch{}this.center=void 0,this.currentCircleId=void 0,this.clickCount=0,this.state==="drawing"&&this.setStarted()}styleFeature(t){const e=y({},{polygonFillColor:"#3f97e0",polygonOutlineColor:"#3f97e0",polygonOutlineWidth:4,polygonFillOpacity:.3,pointColor:"#3f97e0",pointOutlineColor:"#ffffff",pointOutlineWidth:0,pointWidth:6,lineStringColor:"#3f97e0",lineStringWidth:4,zIndex:0});return t.type==="Feature"&&t.geometry.type==="Polygon"&&t.properties.mode===this.mode&&(e.polygonFillColor=this.getHexColorStylingValue(this.styles.fillColor,e.polygonFillColor,t),e.polygonOutlineColor=this.getHexColorStylingValue(this.styles.outlineColor,e.polygonOutlineColor,t),e.polygonOutlineWidth=this.getNumericStylingValue(this.styles.outlineWidth,e.polygonOutlineWidth,t),e.polygonFillOpacity=this.getNumericStylingValue(this.styles.fillOpacity,e.polygonFillOpacity,t)),e}validateFeature(t){return!!super.validateFeature(t)&&t.properties.mode===this.mode&&Qt(t,this.coordinatePrecision)}}class m{constructor({store:t,mode:e,project:i,unproject:n,pointerDistance:o,coordinatePrecision:r}){this.store=void 0,this.mode=void 0,this.project=void 0,this.unproject=void 0,this.pointerDistance=void 0,this.coordinatePrecision=void 0,this.store=t,this.mode=e,this.project=i,this.unproject=n,this.pointerDistance=o,this.coordinatePrecision=r}}class Wt extends m{constructor(t){super(t)}measure(t,e){const{x:i,y:n}=this.project(e[0],e[1]);return St({x:i,y:n},{x:t.containerX,y:t.containerY})}}class Gt extends m{constructor(t){super(t)}create(t){const{containerX:e,containerY:i}=t,n=this.pointerDistance/2;return{type:"Feature",properties:{},geometry:{type:"Polygon",coordinates:[[this.unproject(e-n,i-n),this.unproject(e+n,i-n),this.unproject(e+n,i+n),this.unproject(e-n,i+n),this.unproject(e-n,i-n)].map(o=>[o.lng,o.lat])]}}}}class ee extends m{constructor(t,e,i){super(t),this.config=void 0,this.pixelDistance=void 0,this.clickBoundingBox=void 0,this.getSnappableCoordinate=(n,o)=>this.getSnappable(n,r=>!!(r.properties&&r.properties.mode===this.mode&&r.id!==o)),this.config=t,this.pixelDistance=e,this.clickBoundingBox=i}getSnappable(t,e){const i=this.clickBoundingBox.create(t),n=this.store.search(i,e),o={coord:void 0,minDist:1/0};return n.forEach(r=>{let a;if(r.geometry.type==="Polygon")a=r.geometry.coordinates[0];else{if(r.geometry.type!=="LineString")return;a=r.geometry.coordinates}a.forEach(l=>{const h=this.pixelDistance.measure(t,l);h<o.minDist&&h<this.pointerDistance&&(o.coord=l)})}),o.coord}}function et(s,t){return s[0]===t[0]&&s[1]===t[1]}class ie extends m{constructor(t,e){super(t),this.config=void 0,this.pixelDistance=void 0,this._startEndPoints=[],this.config=t,this.pixelDistance=e}get ids(){return this._startEndPoints.concat()}set ids(t){}create(t,e){if(this.ids.length)throw new Error("Opening and closing points already creating");if(t.length<=3)throw new Error("Requires at least 4 cooridnates");this._startEndPoints=this.store.create([{geometry:{type:"Point",coordinates:t[0]},properties:{mode:e,[_t]:!0}},{geometry:{type:"Point",coordinates:t[t.length-2]},properties:{mode:e,[_t]:!0}}])}delete(){this.ids.length&&(this.store.delete(this.ids),this._startEndPoints=[])}update(t){if(this.ids.length!==2)throw new Error("No closing points to update");this.store.updateGeometry([{id:this.ids[0],geometry:{type:"Point",coordinates:t[0]}},{id:this.ids[1],geometry:{type:"Point",coordinates:t[t.length-3]}}])}isClosingPoint(t){const e=this.store.getGeometryCopy(this.ids[0]),i=this.store.getGeometryCopy(this.ids[1]),n=this.pixelDistance.measure(t,e.coordinates),o=this.pixelDistance.measure(t,i.coordinates);return{isClosing:n<this.pointerDistance,isPreviousClosing:o<this.pointerDistance}}}class se extends Z{constructor(t){if(super(t),this.mode="polygon",this.currentCoordinate=0,this.currentId=void 0,this.allowSelfIntersections=void 0,this.keyEvents=void 0,this.snappingEnabled=void 0,this.snapping=void 0,this.pixelDistance=void 0,this.closingPoints=void 0,this.mouseMove=!1,this.snappingEnabled=!(!t||t.snapping===void 0)&&t.snapping,this.allowSelfIntersections=!t||t.allowSelfIntersections===void 0||t.allowSelfIntersections,(t==null?void 0:t.keyEvents)===null)this.keyEvents={cancel:null,finish:null};else{const e={cancel:"Escape",finish:"Enter"};this.keyEvents=t&&t.keyEvents?y({},e,t.keyEvents):e}}close(){if(!this.currentId)return;const t=this.store.getGeometryCopy(this.currentId).coordinates[0];if(t.length<5)return;this.store.updateGeometry([{id:this.currentId,geometry:{type:"Polygon",coordinates:[[...t.slice(0,-2),t[0]]]}}]);const e=this.currentId;this.currentCoordinate=0,this.currentId=void 0,this.closingPoints.delete(),this.state==="drawing"&&this.setStarted(),this.onFinish(e)}registerBehaviors(t){this.pixelDistance=new Wt(t),this.snapping=new ee(t,this.pixelDistance,new Gt(t)),this.closingPoints=new ie(t,this.pixelDistance)}start(){this.setStarted(),this.setCursor("crosshair")}stop(){this.cleanUp(),this.setStopped(),this.setCursor("unset")}onMouseMove(t){if(this.mouseMove=!0,this.setCursor("crosshair"),!this.currentId||this.currentCoordinate===0)return;const e=this.snappingEnabled?this.snapping.getSnappableCoordinate(t,this.currentId):void 0,i=this.store.getGeometryCopy(this.currentId).coordinates[0];let n;if(e&&(t.lng=e[0],t.lat=e[1]),this.currentCoordinate===1){const o=1/Math.pow(10,this.coordinatePrecision-1),r=Math.max(1e-6,o);n=[i[0],[t.lng,t.lat],[t.lng,t.lat-r],i[0]]}else if(this.currentCoordinate===2)n=[i[0],i[1],[t.lng,t.lat],i[0]];else{const{isClosing:o,isPreviousClosing:r}=this.closingPoints.isClosingPoint(t);r||o?(this.setCursor("pointer"),n=[...i.slice(0,-2),i[0],i[0]]):n=[...i.slice(0,-2),[t.lng,t.lat],i[0]]}this.store.updateGeometry([{id:this.currentId,geometry:{type:"Polygon",coordinates:[n]}}])}onClick(t){this.currentCoordinate>0&&!this.mouseMove&&this.onMouseMove(t),this.mouseMove=!1;const e=this.currentId&&this.snappingEnabled?this.snapping.getSnappableCoordinate(t,this.currentId):void 0;if(this.currentCoordinate===0){e&&(t.lng=e[0],t.lat=e[1]);const[i]=this.store.create([{geometry:{type:"Polygon",coordinates:[[[t.lng,t.lat],[t.lng,t.lat],[t.lng,t.lat],[t.lng,t.lat]]]},properties:{mode:this.mode}}]);this.currentId=i,this.currentCoordinate++,this.setDrawing()}else if(this.currentCoordinate===1&&this.currentId){e&&(t.lng=e[0],t.lat=e[1]);const i=this.store.getGeometryCopy(this.currentId);if(et([t.lng,t.lat],i.coordinates[0][0]))return;this.store.updateGeometry([{id:this.currentId,geometry:{type:"Polygon",coordinates:[[i.coordinates[0][0],[t.lng,t.lat],[t.lng,t.lat],i.coordinates[0][0]]]}}]),this.currentCoordinate++}else if(this.currentCoordinate===2&&this.currentId){e&&(t.lng=e[0],t.lat=e[1]);const i=this.store.getGeometryCopy(this.currentId).coordinates[0];if(et([t.lng,t.lat],i[1]))return;this.currentCoordinate===2&&this.closingPoints.create(i,"polygon"),this.store.updateGeometry([{id:this.currentId,geometry:{type:"Polygon",coordinates:[[i[0],i[1],[t.lng,t.lat],[t.lng,t.lat],i[0]]]}}]),this.currentCoordinate++}else if(this.currentId){const i=this.store.getGeometryCopy(this.currentId).coordinates[0],{isClosing:n,isPreviousClosing:o}=this.closingPoints.isClosingPoint(t);if(o||n)this.close();else{if(e&&(t.lng=e[0],t.lat=e[1]),et([t.lng,t.lat],i[this.currentCoordinate-1]))return;const r=function(a=[[[0,0],[0,1],[1,1],[1,0],[0,0]]]){return{type:"Feature",geometry:{type:"Polygon",coordinates:a},properties:{}}}([[...i.slice(0,-1),[t.lng,t.lat],i[0]]]);if(this.currentCoordinate>2&&!this.allowSelfIntersections&&Lt(r))return;this.store.updateGeometry([{id:this.currentId,geometry:r.geometry}]),this.currentCoordinate++,this.closingPoints.ids.length&&this.closingPoints.update(r.geometry.coordinates[0])}}}onKeyUp(t){t.key===this.keyEvents.cancel?this.cleanUp():t.key===this.keyEvents.finish&&this.close()}onKeyDown(){}onDragStart(){this.setCursor("unset")}onDrag(){}onDragEnd(){this.setCursor("crosshair")}cleanUp(){try{this.currentId&&this.store.delete([this.currentId]),this.closingPoints.ids.length&&this.closingPoints.delete()}catch{}this.currentId=void 0,this.currentCoordinate=0,this.state==="drawing"&&this.setStarted()}styleFeature(t){const e=y({},{polygonFillColor:"#3f97e0",polygonOutlineColor:"#3f97e0",polygonOutlineWidth:4,polygonFillOpacity:.3,pointColor:"#3f97e0",pointOutlineColor:"#ffffff",pointOutlineWidth:0,pointWidth:6,lineStringColor:"#3f97e0",lineStringWidth:4,zIndex:0});if(t.properties.mode===this.mode){if(t.geometry.type==="Polygon")return e.polygonFillColor=this.getHexColorStylingValue(this.styles.fillColor,e.polygonFillColor,t),e.polygonOutlineColor=this.getHexColorStylingValue(this.styles.outlineColor,e.polygonOutlineColor,t),e.polygonOutlineWidth=this.getNumericStylingValue(this.styles.outlineWidth,e.polygonOutlineWidth,t),e.polygonFillOpacity=this.getNumericStylingValue(this.styles.fillOpacity,e.polygonFillOpacity,t),e.zIndex=10,e;if(t.geometry.type==="Point")return e.pointWidth=this.getNumericStylingValue(this.styles.closingPointWidth,e.pointWidth,t),e.pointColor=this.getHexColorStylingValue(this.styles.closingPointColor,e.pointColor,t),e.pointOutlineColor=this.getHexColorStylingValue(this.styles.closingPointOutlineColor,e.pointOutlineColor,t),e.pointOutlineWidth=this.getNumericStylingValue(this.styles.closingPointOutlineWidth,2,t),e.zIndex=30,e}return e}validateFeature(t){return!!super.validateFeature(t)&&t.properties.mode===this.mode&&Bt(t,this.coordinatePrecision)}}function ne(s,t,e,i,n){const o=i(s[0],s[1]),r=i(t[0],t[1]),{lng:a,lat:l}=n((o.x+r.x)/2,(o.y+r.y)/2);return[f(a,e),f(l,e)]}function Mt(s,t,e,i){const n=[];for(let o=0;o<s.length-1;o++){const r=ne(s[o],s[o+1],t,e,i);n.push(r)}return n}class oe extends m{constructor(t,e){super(t),this.config=void 0,this.selectionPointBehavior=void 0,this._midPoints=[],this.config=t,this.selectionPointBehavior=e}get ids(){return this._midPoints.concat()}set ids(t){}insert(t,e){const i=this.store.getGeometryCopy(t),{midPointFeatureId:n,midPointSegment:o}=this.store.getPropertiesCopy(t),r=this.store.getGeometryCopy(n),a=r.type==="Polygon"?r.coordinates[0]:r.coordinates;a.splice(o+1,0,i.coordinates),r.coordinates=r.type==="Polygon"?[a]:a,this.store.updateGeometry([{id:n,geometry:r}]),this.store.delete([...this._midPoints,...this.selectionPointBehavior.ids]),this.create(a,n,e),this.selectionPointBehavior.create(a,r.type,n)}create(t,e,i){if(!this.store.has(e))throw new Error("Store does not have feature with this id");this._midPoints=this.store.create(function(n,o,r,a,l){return Mt(n,r,a,l).map((h,c)=>({geometry:{type:"Point",coordinates:h},properties:o(c)}))}(t,n=>({mode:this.mode,[H]:!0,midPointSegment:n,midPointFeatureId:e}),i,this.config.project,this.config.unproject))}delete(){this._midPoints.length&&(this.store.delete(this._midPoints),this._midPoints=[])}getUpdated(t){if(this._midPoints.length!==0)return Mt(t,this.coordinatePrecision,this.config.project,this.config.unproject).map((e,i)=>({id:this._midPoints[i],geometry:{type:"Point",coordinates:e}}))}}class re extends m{constructor(t){super(t),this._selectionPoints=[]}get ids(){return this._selectionPoints.concat()}set ids(t){}create(t,e,i){this._selectionPoints=this.store.create(function(n,o,r){const a=[],l=o==="Polygon"?n.length-1:n.length;for(let h=0;h<l;h++)a.push({geometry:{type:"Point",coordinates:n[h]},properties:r(h)});return a}(t,e,n=>({mode:this.mode,selectionPoint:!0,selectionPointFeatureId:i,index:n})))}delete(){this.ids.length&&(this.store.delete(this.ids),this._selectionPoints=[])}getUpdated(t){if(this._selectionPoints.length!==0)return this._selectionPoints.map((e,i)=>({id:e,geometry:{type:"Point",coordinates:t[i]}}))}getOneUpdated(t,e){if(this._selectionPoints[t]!==void 0)return{id:this._selectionPoints[t],geometry:{type:"Point",coordinates:e}}}}function ae(s,t){let e=!1;for(let r=0,a=t.length;r<a;r++){const l=t[r];for(let h=0,c=l.length,d=c-1;h<c;d=h++)(n=l[h])[1]>(i=s)[1]!=(o=l[d])[1]>i[1]&&i[0]<(o[0]-n[0])*(i[1]-n[1])/(o[1]-n[1])+n[0]&&(e=!e)}var i,n,o;return e}const le=(s,t,e)=>{const i=o=>o*o,n=(o,r)=>i(o.x-r.x)+i(o.y-r.y);return Math.sqrt(((o,r,a)=>{const l=n(r,a);if(l===0)return n(o,r);let h=((o.x-r.x)*(a.x-r.x)+(o.y-r.y)*(a.y-r.y))/l;return h=Math.max(0,Math.min(1,h)),n(o,{x:r.x+h*(a.x-r.x),y:r.y+h*(a.y-r.y)})})(s,t,e))};class he extends m{constructor(t,e,i){super(t),this.config=void 0,this.createClickBoundingBox=void 0,this.pixelDistance=void 0,this.config=t,this.createClickBoundingBox=e,this.pixelDistance=i}find(t,e){let i,n,o=1/0,r=1/0;const a=this.createClickBoundingBox.create(t),l=this.store.search(a);for(let h=0;h<l.length;h++){const c=l[h],d=c.geometry;if(d.type==="Point"){if(c.properties.selectionPoint||!e&&c.properties[H])continue;const g=this.pixelDistance.measure(t,d.coordinates);c.properties[H]&&g<this.pointerDistance&&g<r?(r=g,n=c):!c.properties[H]&&g<this.pointerDistance&&g<o&&(o=g,i=c)}else if(d.type==="LineString")for(let g=0;g<d.coordinates.length-1;g++){const u=d.coordinates[g],v=d.coordinates[g+1],p=le({x:t.containerX,y:t.containerY},this.project(u[0],u[1]),this.project(v[0],v[1]));p<this.pointerDistance&&p<o&&(o=p,i=c)}else d.type==="Polygon"&&ae([t.lng,t.lat],d.coordinates)&&(o=0,i=c)}return{clickedFeature:i,clickedMidPoint:n}}}class de extends m{constructor(t,e,i,n){super(t),this.config=void 0,this.featuresAtMouseEvent=void 0,this.selectionPoints=void 0,this.midPoints=void 0,this.draggedFeatureId=null,this.dragPosition=void 0,this.config=t,this.featuresAtMouseEvent=e,this.selectionPoints=i,this.midPoints=n}startDragging(t,e){this.draggedFeatureId=e,this.dragPosition=[t.lng,t.lat]}stopDragging(){this.draggedFeatureId=null,this.dragPosition=void 0}isDragging(){return this.draggedFeatureId!==null}canDrag(t,e){const{clickedFeature:i}=this.featuresAtMouseEvent.find(t,!0);return!(!i||i.id!==e)}drag(t){if(!this.draggedFeatureId)return;const e=this.store.getGeometryCopy(this.draggedFeatureId),i=[t.lng,t.lat];if(e.type==="Polygon"||e.type==="LineString"){let n,o;if(e.type==="Polygon"?(n=e.coordinates[0],o=n.length-1):(n=e.coordinates,o=n.length),!this.dragPosition)return!1;for(let l=0;l<o;l++){const h=n[l],c=[this.dragPosition[0]-i[0],this.dragPosition[1]-i[1]],d=f(h[0]-c[0],this.config.coordinatePrecision),g=f(h[1]-c[1],this.config.coordinatePrecision);if(d>180||d<-180||g>90||g<-90)return!1;n[l]=[d,g]}e.type==="Polygon"&&(n[n.length-1]=[n[0][0],n[0][1]]);const r=this.selectionPoints.getUpdated(n)||[],a=this.midPoints.getUpdated(n)||[];this.store.updateGeometry([{id:this.draggedFeatureId,geometry:e},...r,...a]),this.dragPosition=[t.lng,t.lat]}else e.type==="Point"&&(this.store.updateGeometry([{id:this.draggedFeatureId,geometry:{type:"Point",coordinates:i}}]),this.dragPosition=[t.lng,t.lat])}}class ce extends m{constructor(t,e,i,n){super(t),this.config=void 0,this.pixelDistance=void 0,this.selectionPoints=void 0,this.midPoints=void 0,this.draggedCoordinate={id:null,index:-1},this.config=t,this.pixelDistance=e,this.selectionPoints=i,this.midPoints=n}getClosestCoordinate(t,e){const i={dist:1/0,index:-1,isFirstOrLastPolygonCoord:!1};let n;if(e.type==="LineString")n=e.coordinates;else{if(e.type!=="Polygon")return i;n=e.coordinates[0]}for(let o=0;o<n.length;o++){const r=this.pixelDistance.measure(t,n[o]);if(r<this.pointerDistance&&r<i.dist){const a=e.type==="Polygon"&&(o===n.length-1||o===0);i.dist=r,i.index=a?0:o,i.isFirstOrLastPolygonCoord=a}}return i}getDraggableIndex(t,e){const i=this.store.getGeometryCopy(e),n=this.getClosestCoordinate(t,i);return n.index===-1?-1:n.index}drag(t){if(!this.draggedCoordinate.id)return!1;const e=this.draggedCoordinate.index,i=this.store.getGeometryCopy(this.draggedCoordinate.id),n=i.type==="LineString"?i.coordinates:i.coordinates[0],o=[t.lng,t.lat];if(t.lng>180||t.lng<-180||t.lat>90||t.lat<-90)return!1;if(i.type!=="Polygon"||e!==n.length-1&&e!==0)n[e]=o;else{const h=n.length-1;n[0]=o,n[h]=o}const r=this.selectionPoints.getOneUpdated(e,o),a=r?[r]:[],l=this.midPoints.getUpdated(n)||[];return this.store.updateGeometry([{id:this.draggedCoordinate.id,geometry:i},...a,...l]),!0}isDragging(){return this.draggedCoordinate.id!==null}startDragging(t,e){this.draggedCoordinate={id:t,index:e}}stopDragging(){this.draggedCoordinate={id:null,index:-1}}}function z(s){let t=0,e=0,i=0;return(s.geometry.type==="Polygon"?s.geometry.coordinates[0].slice(0,-1):s.geometry.coordinates).forEach(n=>{t+=n[0],e+=n[1],i++},!0),[t/i,e/i]}function at(s,t){const e=s,i=t,n=P(e[1]),o=P(i[1]);let r=P(i[0]-e[0]);r>Math.PI&&(r-=2*Math.PI),r<-Math.PI&&(r+=2*Math.PI);const a=Math.log(Math.tan(o/2+Math.PI/4)/Math.tan(n/2+Math.PI/4)),l=(rt(Math.atan2(r,a))+360)%360;return l>180?-(360-l):l}function At(s,t,e){const i=t/63710088e-1,n=s[0]*Math.PI/180,o=P(s[1]),r=P(e),a=i*Math.cos(r);let l=o+a;Math.abs(l)>Math.PI/2&&(l=l>0?Math.PI-l:-Math.PI-l);const h=Math.log(Math.tan(l/2+Math.PI/4)/Math.tan(o/2+Math.PI/4)),c=Math.abs(h)>1e-11?a/h:Math.cos(o),d=[(180*(n+i*Math.sin(r)/c)/Math.PI+540)%360-180,180*l/Math.PI];return d[0]+=d[0]-s[0]>180?-360:s[0]-d[0]>180?360:0,d}function jt(s,t){s[0]+=s[0]-t[0]>180?-360:t[0]-s[0]>180?360:0;const e=t[1]*Math.PI/180,i=s[1]*Math.PI/180,n=i-e;let o=Math.abs(s[0]-t[0])*Math.PI/180;o>Math.PI&&(o-=2*Math.PI);const r=Math.log(Math.tan(i/2+Math.PI/4)/Math.tan(e/2+Math.PI/4)),a=Math.abs(r)>1e-11?n/r:Math.cos(e);return 63710088e-1*Math.sqrt(n*n+a*a*o*o)}class ge extends m{constructor(t,e,i){super(t),this.config=void 0,this.selectionPoints=void 0,this.midPoints=void 0,this.lastBearing=void 0,this.config=t,this.selectionPoints=e,this.midPoints=i}reset(){this.lastBearing=void 0}rotate(t,e){const i=this.store.getGeometryCopy(e);if(i.type!=="Polygon"&&i.type!=="LineString")return;const n=[t.lng,t.lat],o=at(z({type:"Feature",geometry:i,properties:{}}),n);if(!this.lastBearing)return void(this.lastBearing=o+180);(function(h,c){if(c===0)return h;const d=z(h);(h.geometry.type==="Polygon"?h.geometry.coordinates[0]:h.geometry.coordinates).forEach(g=>{const u=at(d,g)+c,v=jt(d,g),p=At(d,v,u);g[0]=p[0],g[1]=p[1]})})({type:"Feature",geometry:i,properties:{}},-(this.lastBearing-(o+180)));const r=i.type==="Polygon"?i.coordinates[0]:i.coordinates;r.forEach(h=>{h[0]=f(h[0],this.coordinatePrecision),h[1]=f(h[1],this.coordinatePrecision)});const a=this.midPoints.getUpdated(r)||[],l=this.selectionPoints.getUpdated(r)||[];this.store.updateGeometry([{id:e,geometry:i},...l,...a]),this.lastBearing=o+180}}class ue extends m{constructor(t,e,i){super(t),this.config=void 0,this.selectionPoints=void 0,this.midPoints=void 0,this.lastDistance=void 0,this.config=t,this.selectionPoints=e,this.midPoints=i}reset(){this.lastDistance=void 0}scale(t,e){const i=this.store.getGeometryCopy(e);if(i.type!=="Polygon"&&i.type!=="LineString")return;const n=[t.lng,t.lat],o=Ft(z({type:"Feature",geometry:i,properties:{}}),n);if(!this.lastDistance)return void(this.lastDistance=o);(function(h,c){if(c===1)return h;const d=z(h);(h.geometry.type==="Polygon"?h.geometry.coordinates[0]:h.geometry.coordinates).forEach(g=>{const u=jt(d,g),v=at(d,g),p=At(d,u*c,v);g[0]=p[0],g[1]=p[1]})})({type:"Feature",geometry:i,properties:{}},1-(this.lastDistance-o)/o);const r=i.type==="Polygon"?i.coordinates[0]:i.coordinates;r.forEach(h=>{h[0]=f(h[0],this.coordinatePrecision),h[1]=f(h[1],this.coordinatePrecision)});const a=this.midPoints.getUpdated(r)||[],l=this.selectionPoints.getUpdated(r)||[];this.store.updateGeometry([{id:e,geometry:i},...l,...a]),this.lastDistance=o}}class pe extends Z{constructor(t){if(super(t),this.type=b.Select,this.mode="select",this.dragEventThrottle=5,this.dragEventCount=0,this.selected=[],this.flags=void 0,this.keyEvents=void 0,this.selectionPoints=void 0,this.midPoints=void 0,this.featuresAtMouseEvent=void 0,this.pixelDistance=void 0,this.clickBoundingBox=void 0,this.dragFeature=void 0,this.dragCoordinate=void 0,this.rotateFeature=void 0,this.scaleFeature=void 0,this.flags=t&&t.flags?t.flags:{},(t==null?void 0:t.keyEvents)===null)this.keyEvents={deselect:null,delete:null,rotate:null,scale:null};else{const e={deselect:"Escape",delete:"Delete",rotate:["Control","r"],scale:["Control","s"]};this.keyEvents=t&&t.keyEvents?y({},e,t.keyEvents):e}this.dragEventThrottle=t&&t.dragEventThrottle!==void 0&&t.dragEventThrottle||5}registerBehaviors(t){this.pixelDistance=new Wt(t),this.clickBoundingBox=new Gt(t),this.featuresAtMouseEvent=new he(t,this.clickBoundingBox,this.pixelDistance),this.selectionPoints=new re(t),this.midPoints=new oe(t,this.selectionPoints),this.rotateFeature=new ge(t,this.selectionPoints,this.midPoints),this.scaleFeature=new ue(t,this.selectionPoints,this.midPoints),this.dragFeature=new de(t,this.featuresAtMouseEvent,this.selectionPoints,this.midPoints),this.dragCoordinate=new ce(t,this.pixelDistance,this.selectionPoints,this.midPoints)}deselect(){const t=this.selected.filter(e=>this.store.has(e)).map(e=>({id:e,property:ot,value:!1}));this.store.updateProperty(t),this.onDeselect(this.selected[0]),this.selected=[],this.selectionPoints.delete(),this.midPoints.delete()}deleteSelected(){this.store.delete(this.selected),this.selected=[]}onRightClick(t){if(!this.selectionPoints.ids.length)return;let e,i=1/0;if(this.selectionPoints.ids.forEach(c=>{const d=this.store.getGeometryCopy(c),g=this.pixelDistance.measure(t,d.coordinates);g<this.pointerDistance&&g<i&&(i=g,e=this.store.getPropertiesCopy(c))}),!e)return;const n=e.selectionPointFeatureId,o=e.index,r=this.store.getPropertiesCopy(n),a=this.flags[r.mode];if(!(a&&a.feature&&a.feature.coordinates&&a.feature.coordinates.deletable))return;const l=this.store.getGeometryCopy(n);let h;if(l.type==="Polygon"){if(h=l.coordinates[0],h.length<=4)return}else if(l.type==="LineString"&&(h=l.coordinates,h.length<=3))return;h&&(l.type==="Polygon"&&o===0||o===h.length-1?(h.shift(),h.pop(),h.push([h[0][0],h[0][1]])):h.splice(o,1),this.store.delete([...this.midPoints.ids,...this.selectionPoints.ids]),this.store.updateGeometry([{id:n,geometry:l}]),this.selectionPoints.create(h,l.type,n),a&&a.feature&&a.feature.coordinates&&a.feature.coordinates.midpoints&&this.midPoints.create(h,n,this.coordinatePrecision))}onLeftClick(t){const{clickedFeature:e,clickedMidPoint:i}=this.featuresAtMouseEvent.find(t,this.selected.length>0);if(this.selected.length&&i)this.midPoints.insert(i.id,this.coordinatePrecision);else if(e){const{mode:n}=this.store.getPropertiesCopy(e.id),o=this.selected[0];if(o){if(o===e.id)return;this.deselect()}const r=this.flags[n];if(!r||!r.feature)return;this.selected=[e.id],this.store.updateProperty([{id:e.id,property:"selected",value:!0}]),this.onSelect(e.id);const{type:a,coordinates:l}=this.store.getGeometryCopy(e.id);if(a!=="LineString"&&a!=="Polygon")return;const h=a==="LineString"?l:l[0];h&&r&&r.feature.coordinates&&(this.selectionPoints.create(h,a,e.id),r.feature.coordinates.midpoints&&this.midPoints.create(h,e.id,this.coordinatePrecision))}else if(this.selected.length)return void this.deselect()}start(){this.setStarted()}stop(){this.cleanUp(),this.setStopped()}onClick(t){t.button!=="right"?t.button==="left"&&this.onLeftClick(t):this.onRightClick(t)}canScale(t){return this.keyEvents.scale&&this.keyEvents.scale.every(e=>t.heldKeys.includes(e))}canRotate(t){return this.keyEvents.rotate&&this.keyEvents.rotate.every(e=>t.heldKeys.includes(e))}preventDefaultKeyEvent(t){const e=this.canRotate(t),i=this.canScale(t);(e||i)&&t.preventDefault()}onKeyDown(t){this.preventDefaultKeyEvent(t)}onKeyUp(t){if(this.preventDefaultKeyEvent(t),this.keyEvents.delete&&t.key===this.keyEvents.delete){if(!this.selected.length)return;this.onDeselect(this.selected[0]),this.deleteSelected(),this.selectionPoints.delete(),this.midPoints.delete()}else this.keyEvents.deselect&&t.key===this.keyEvents.deselect&&this.cleanUp()}cleanUp(){this.selected.length&&this.deselect()}onDragStart(t,e){if(!this.selected.length)return;const i=this.store.getPropertiesCopy(this.selected[0]),n=this.flags[i.mode];if(!(n&&n.feature&&(n.feature.draggable||n.feature.coordinates&&n.feature.coordinates.draggable)))return;this.dragEventCount=0,this.setCursor("grabbing");const o=this.selected[0],r=this.dragCoordinate.getDraggableIndex(t,o);return n&&n.feature&&n.feature.coordinates&&n.feature.coordinates.draggable&&r!==-1?(this.dragCoordinate.startDragging(o,r),void e(!1)):n&&n.feature&&n.feature.draggable&&this.dragFeature.canDrag(t,o)?(this.dragFeature.startDragging(t,o),void e(!1)):void 0}onDrag(t,e){const i=this.selected[0];if(!i)return;const n=this.store.getPropertiesCopy(i),o=this.flags[n.mode];return this.dragEventCount++,this.dragEventCount%this.dragEventThrottle!=0?o&&o.feature&&o.feature.rotateable&&this.canRotate(t)?(e(!1),void this.rotateFeature.rotate(t,i)):o&&o.feature&&o.feature.scaleable&&this.canScale(t)?(e(!1),void this.scaleFeature.scale(t,i)):void(this.dragCoordinate.isDragging()?this.dragCoordinate.drag(t):this.dragFeature.isDragging()?this.dragFeature.drag(t):e(!0)):void 0}onDragEnd(t,e){this.setCursor("grab"),this.dragCoordinate.stopDragging(),this.dragFeature.stopDragging(),this.rotateFeature.reset(),this.scaleFeature.reset(),e(!0)}onMouseMove(t){if(!this.selected.length||this.dragFeature.isDragging())return;let e=!1;this.midPoints.ids.forEach(i=>{if(e)return;const n=this.store.getGeometryCopy(i);this.pixelDistance.measure(t,n.coordinates)<this.pointerDistance&&(e=!0)}),this.selectionPoints.ids.forEach(i=>{const n=this.store.getGeometryCopy(i);this.pixelDistance.measure(t,n.coordinates)<this.pointerDistance&&(e=!1)}),this.setCursor(e?"crosshair":"unset")}styleFeature(t){const e=y({},{polygonFillColor:"#3f97e0",polygonOutlineColor:"#3f97e0",polygonOutlineWidth:4,polygonFillOpacity:.3,pointColor:"#3f97e0",pointOutlineColor:"#ffffff",pointOutlineWidth:0,pointWidth:6,lineStringColor:"#3f97e0",lineStringWidth:4,zIndex:0});if(t.properties.mode===this.mode&&t.geometry.type==="Point"){if(t.properties.selectionPoint)return e.pointColor=this.getHexColorStylingValue(this.styles.selectionPointColor,e.pointColor,t),e.pointOutlineColor=this.getHexColorStylingValue(this.styles.selectionPointOutlineColor,e.pointOutlineColor,t),e.pointWidth=this.getNumericStylingValue(this.styles.selectionPointWidth,e.pointWidth,t),e.pointOutlineWidth=this.getNumericStylingValue(this.styles.selectionPointOutlineWidth,2,t),e.zIndex=30,e;if(t.properties.midPoint)return e.pointColor=this.getHexColorStylingValue(this.styles.midPointColor,e.pointColor,t),e.pointOutlineColor=this.getHexColorStylingValue(this.styles.midPointOutlineColor,e.pointOutlineColor,t),e.pointWidth=this.getNumericStylingValue(this.styles.midPointWidth,4,t),e.pointOutlineWidth=this.getNumericStylingValue(this.styles.midPointOutlineWidth,2,t),e.zIndex=40,e}else if(t.properties[ot]){if(t.geometry.type==="Polygon")return e.polygonFillColor=this.getHexColorStylingValue(this.styles.selectedPolygonColor,e.polygonFillColor,t),e.polygonOutlineWidth=this.getNumericStylingValue(this.styles.selectedPolygonOutlineWidth,e.polygonOutlineWidth,t),e.polygonOutlineColor=this.getHexColorStylingValue(this.styles.selectedPolygonOutlineColor,e.polygonOutlineColor,t),e.polygonFillOpacity=this.getNumericStylingValue(this.styles.selectedPolygonFillOpacity,e.polygonFillOpacity,t),e.zIndex=10,e;if(t.geometry.type==="LineString")return e.lineStringColor=this.getHexColorStylingValue(this.styles.selectedLineStringColor,e.lineStringColor,t),e.lineStringWidth=this.getNumericStylingValue(this.styles.selectedLineStringWidth,e.lineStringWidth,t),e.zIndex=10,e;if(t.geometry.type==="Point")return e.pointWidth=this.getNumericStylingValue(this.styles.selectedPointWidth,e.pointWidth,t),e.pointColor=this.getHexColorStylingValue(this.styles.selectedPointColor,e.pointColor,t),e.pointOutlineColor=this.getHexColorStylingValue(this.styles.selectedPointOutlineColor,e.pointOutlineColor,t),e.pointOutlineWidth=this.getNumericStylingValue(this.styles.selectedPointOutlineWidth,e.pointOutlineWidth,t),e.zIndex=10,e}return e}}class ye extends Z{constructor(...t){super(...t),this.type=b.Static,this.mode="static"}start(){}stop(){}onKeyUp(){}onKeyDown(){}onClick(){}onDragStart(){}onDrag(){}onDragEnd(){}onMouseMove(){}cleanUp(){}styleFeature(){return y({},{polygonFillColor:"#3f97e0",polygonOutlineColor:"#3f97e0",polygonOutlineWidth:4,polygonFillOpacity:.3,pointColor:"#3f97e0",pointOutlineColor:"#ffffff",pointOutlineWidth:0,pointWidth:6,lineStringColor:"#3f97e0",lineStringWidth:4,zIndex:0})}}const wt=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(s){const t=16*Math.random()|0;return(s=="x"?t:3&t|8).toString(16)})};function Xt(s,t,e,i,n){for(;i>e;){if(i-e>600){const l=i-e+1,h=t-e+1,c=Math.log(l),d=.5*Math.exp(2*c/3),g=.5*Math.sqrt(c*d*(l-d)/l)*(h-l/2<0?-1:1);Xt(s,t,Math.max(e,Math.floor(t-h*d/l+g)),Math.min(i,Math.floor(t+(l-h)*d/l+g)),n)}const o=s[t];let r=e,a=i;for(I(s,e,t),n(s[i],o)>0&&I(s,e,i);r<a;){for(I(s,r,a),r++,a--;n(s[r],o)<0;)r++;for(;n(s[a],o)>0;)a--}n(s[e],o)===0?I(s,e,a):(a++,I(s,a,i)),a<=t&&(e=a+1),t<=a&&(i=a-1)}}function I(s,t,e){const i=s[t];s[t]=s[e],s[e]=i}function w(s,t){k(s,0,s.children.length,t,s)}function k(s,t,e,i,n){n||(n=E([])),n.minX=1/0,n.minY=1/0,n.maxX=-1/0,n.maxY=-1/0;for(let o=t;o<e;o++){const r=s.children[o];O(n,s.leaf?i(r):r)}return n}function O(s,t){return s.minX=Math.min(s.minX,t.minX),s.minY=Math.min(s.minY,t.minY),s.maxX=Math.max(s.maxX,t.maxX),s.maxY=Math.max(s.maxY,t.maxY),s}function fe(s,t){return s.minX-t.minX}function me(s,t){return s.minY-t.minY}function it(s){return(s.maxX-s.minX)*(s.maxY-s.minY)}function K(s){return s.maxX-s.minX+(s.maxY-s.minY)}function ve(s,t){const e=Math.max(s.minX,t.minX),i=Math.max(s.minY,t.minY),n=Math.min(s.maxX,t.maxX),o=Math.min(s.maxY,t.maxY);return Math.max(0,n-e)*Math.max(0,o-i)}function st(s,t){return s.minX<=t.minX&&s.minY<=t.minY&&t.maxX<=s.maxX&&t.maxY<=s.maxY}function T(s,t){return t.minX<=s.maxX&&t.minY<=s.maxY&&t.maxX>=s.minX&&t.maxY>=s.minY}function E(s){return{children:s,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function Et(s,t,e,i,n){const o=[t,e];for(;o.length;){if((e=o.pop())-(t=o.pop())<=i)continue;const r=t+Math.ceil((e-t)/i/2)*i;Xt(s,r,t,e,n),o.push(t,r,r,e)}}class _e{constructor(t){this._maxEntries=void 0,this._minEntries=void 0,this.data=void 0,this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),this.clear()}search(t){let e=this.data;const i=[];if(!T(t,e))return i;const n=this.toBBox,o=[];for(;e;){for(let r=0;r<e.children.length;r++){const a=e.children[r],l=e.leaf?n(a):a;T(t,l)&&(e.leaf?i.push(a):st(t,l)?this._all(a,i):o.push(a))}e=o.pop()}return i}collides(t){let e=this.data;if(T(t,e)){const i=[];for(;e;){for(let n=0;n<e.children.length;n++){const o=e.children[n],r=e.leaf?this.toBBox(o):o;if(T(t,r)){if(e.leaf||st(t,r))return!0;i.push(o)}}e=i.pop()}}return!1}load(t){if(t.length<this._minEntries){for(let i=0;i<t.length;i++)this.insert(t[i]);return}let e=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===e.height)this._splitRoot(this.data,e);else{if(this.data.height<e.height){const i=this.data;this.data=e,e=i}this._insert(e,this.data.height-e.height-1,!0)}else this.data=e}insert(t){this._insert(t,this.data.height-1)}clear(){this.data=E([])}remove(t){let e=this.data;const i=this.toBBox(t),n=[],o=[];let r,a,l=!1;for(;e||n.length;){if(e||(e=n.pop(),a=n[n.length-1],r=o.pop(),l=!0),e.leaf){const h=e.children.indexOf(t);h!==-1&&(e.children.splice(h,1),n.push(e),this._condense(n))}l||e.leaf||!st(e,i)?a?(r++,e=a.children[r],l=!1):e=null:(n.push(e),o.push(r),r=0,a=e,e=e.children[0])}}toBBox(t){return t}compareMinX(t,e){return t.minX-e.minX}compareMinY(t,e){return t.minY-e.minY}_all(t,e){const i=[];for(;t;)t.leaf?e.push(...t.children):i.push(...t.children),t=i.pop();return e}_build(t,e,i,n){const o=i-e+1;let r,a=this._maxEntries;if(o<=a)return r=E(t.slice(e,i+1)),w(r,this.toBBox),r;n||(n=Math.ceil(Math.log(o)/Math.log(a)),a=Math.ceil(o/Math.pow(a,n-1))),r=E([]),r.leaf=!1,r.height=n;const l=Math.ceil(o/a),h=l*Math.ceil(Math.sqrt(a));Et(t,e,i,h,this.compareMinX);for(let c=e;c<=i;c+=h){const d=Math.min(c+h-1,i);Et(t,c,d,l,this.compareMinY);for(let g=c;g<=d;g+=l){const u=Math.min(g+l-1,d);r.children.push(this._build(t,g,u,n-1))}}return w(r,this.toBBox),r}_chooseSubtree(t,e,i,n){for(;n.push(e),!e.leaf&&n.length-1!==i;){let a,l=1/0,h=1/0;for(let c=0;c<e.children.length;c++){const d=e.children[c],g=it(d),u=(o=t,r=d,(Math.max(r.maxX,o.maxX)-Math.min(r.minX,o.minX))*(Math.max(r.maxY,o.maxY)-Math.min(r.minY,o.minY))-g);u<h?(h=u,l=g<l?g:l,a=d):u===h&&g<l&&(l=g,a=d)}e=a||e.children[0]}var o,r;return e}_insert(t,e,i){const n=i?t:this.toBBox(t),o=[],r=this._chooseSubtree(n,this.data,e,o);for(r.children.push(t),O(r,n);e>=0&&o[e].children.length>this._maxEntries;)this._split(o,e),e--;this._adjustParentBBoxes(n,o,e)}_split(t,e){const i=t[e],n=i.children.length,o=this._minEntries;this._chooseSplitAxis(i,o,n);const r=this._chooseSplitIndex(i,o,n),a=E(i.children.splice(r,i.children.length-r));a.height=i.height,a.leaf=i.leaf,w(i,this.toBBox),w(a,this.toBBox),e?t[e-1].children.push(a):this._splitRoot(i,a)}_splitRoot(t,e){this.data=E([t,e]),this.data.height=t.height+1,this.data.leaf=!1,w(this.data,this.toBBox)}_chooseSplitIndex(t,e,i){let n,o=1/0,r=1/0;for(let a=e;a<=i-e;a++){const l=k(t,0,a,this.toBBox),h=k(t,a,i,this.toBBox),c=ve(l,h),d=it(l)+it(h);c<o?(o=c,n=a,r=d<r?d:r):c===o&&d<r&&(r=d,n=a)}return n||i-e}_chooseSplitAxis(t,e,i){const n=t.leaf?this.compareMinX:fe,o=t.leaf?this.compareMinY:me;this._allDistMargin(t,e,i,n)<this._allDistMargin(t,e,i,o)&&t.children.sort(n)}_allDistMargin(t,e,i,n){t.children.sort(n);const o=this.toBBox,r=k(t,0,e,o),a=k(t,i-e,i,o);let l=K(r)+K(a);for(let h=e;h<i-e;h++){const c=t.children[h];O(r,t.leaf?o(c):c),l+=K(r)}for(let h=i-e-1;h>=e;h--){const c=t.children[h];O(a,t.leaf?o(c):c),l+=K(a)}return l}_adjustParentBBoxes(t,e,i){for(let n=i;n>=0;n--)O(e[n],t)}_condense(t){for(let e,i=t.length-1;i>=0;i--)t[i].children.length===0?i>0?(e=t[i-1].children,e.splice(e.indexOf(t[i]),1)):this.clear():w(t[i],this.toBBox)}}class Pe{constructor(t){this.tree=void 0,this.idToNode=void 0,this.nodeToId=void 0,this.tree=new _e(t&&t.maxEntries?t.maxEntries:9),this.idToNode=new Map,this.nodeToId=new Map}setMaps(t,e){this.idToNode.set(String(t.id),e),this.nodeToId.set(e,String(t.id))}toBBox(t){const e=[],i=[];let n;if(t.geometry.type==="Polygon")n=t.geometry.coordinates[0];else if(t.geometry.type==="LineString")n=t.geometry.coordinates;else{if(t.geometry.type!=="Point")throw new Error("Not a valid feature to turn into a bounding box");n=[t.geometry.coordinates]}for(let a=0;a<n.length;a++)i.push(n[a][1]),e.push(n[a][0]);const o=Math.min(...i),r=Math.max(...i);return{minX:Math.min(...e),minY:o,maxX:Math.max(...e),maxY:r}}insert(t){if(this.idToNode.get(String(t.id)))throw new Error("Feature already exists");const e=this.toBBox(t);this.setMaps(t,e),this.tree.insert(e)}load(t){const e=[],i=new Set;t.forEach(n=>{const o=this.toBBox(n);if(this.setMaps(n,o),i.has(String(n.id)))throw new Error(`Duplicate feature ID found ${n.id}`);i.add(String(n.id)),e.push(o)}),this.tree.load(e)}update(t){this.remove(t.id);const e=this.toBBox(t);this.setMaps(t,e),this.tree.insert(e)}remove(t){const e=this.idToNode.get(t);if(!e)throw new Error(`${t} not inserted into the spatial index`);this.tree.remove(e)}clear(){this.tree.clear()}search(t){return this.tree.search(this.toBBox(t)).map(e=>this.nodeToId.get(e))}collides(t){return this.tree.collides(this.toBBox(t))}}class Ce{constructor(t){this.tracked=void 0,this.spatialIndex=void 0,this.store=void 0,this._onChange=()=>{},this.store={},this.spatialIndex=new Pe,this.tracked=!t||t.tracked!==!1}getId(){return wt()}clone(t){return JSON.parse(JSON.stringify(t))}has(t){return!!this.store[t]}load(t,e){if(t.length===0)return;const i=this.clone(t);i.forEach(o=>{o.id||(o.id=wt()),this.tracked&&(o.properties.createdAt?Pt(o.properties.createdAt):o.properties.createdAt=+new Date,o.properties.updatedAt?Pt(o.properties.updatedAt):o.properties.updatedAt=+new Date)});const n=[];i.forEach(o=>{if(e&&!e(o))throw new Error(`Feature is not ${o.id} valid: ${JSON.stringify(o)}`);this.store[o.id]=o,n.push(o.id)}),this.spatialIndex.load(i),this._onChange(n,"create")}search(t,e){const i=this.spatialIndex.search(t).map(n=>this.store[n]);return this.clone(e?i.filter(e):i)}registerOnChange(t){this._onChange=(e,i)=>{t(e,i)}}getGeometryCopy(t){const e=this.store[t];if(!e)throw new Error(`No feature with this id (${t}), can not get geometry copy`);return this.clone(e.geometry)}getPropertiesCopy(t){const e=this.store[t];if(!e)throw new Error(`No feature with this id (${t}), can not get properties copy`);return this.clone(e.properties)}updateProperty(t){const e=[];t.forEach(({id:i,property:n,value:o})=>{const r=this.store[i];if(!r)throw new Error(`No feature with this (${i}), can not update geometry`);e.push(i),r.properties[n]=o,this.tracked&&(r.properties.updatedAt=+new Date)}),this._onChange&&this._onChange(e,"update")}updateGeometry(t){const e=[];t.forEach(({id:i,geometry:n})=>{e.push(i);const o=this.store[i];if(!o)throw new Error(`No feature with this (${i}), can not update geometry`);o.geometry=this.clone(n),this.spatialIndex.update(o),this.tracked&&(o.properties.updatedAt=+new Date)}),this._onChange&&this._onChange(e,"update")}create(t){const e=[];return t.forEach(({geometry:i,properties:n})=>{let o,r=y({},n);this.tracked&&(o=+new Date,n?(r.createdAt=typeof n.createdAt=="number"?n.createdAt:o,r.updatedAt=typeof n.updatedAt=="number"?n.updatedAt:o):r={createdAt:o,updatedAt:o});const a=this.getId(),l={id:a,type:"Feature",geometry:i,properties:r};this.store[a]=l,this.spatialIndex.insert(l),e.push(a)}),this._onChange&&this._onChange([...e],"create"),e}delete(t){t.forEach(e=>{if(!this.store[e])throw new Error("No feature with this id, can not delete");delete this.store[e],this.spatialIndex.remove(e)}),this._onChange&&this._onChange([...t],"delete")}copyAll(){return this.clone(Object.keys(this.store).map(t=>this.store[t]))}clear(){this.store={},this.spatialIndex.clear()}size(){return Object.keys(this.store).length}}class xe{constructor(t){this._modes=void 0,this._mode=void 0,this._adapter=void 0,this._enabled=!1,this._store=void 0,this._eventListeners=void 0,this._instanceSelectMode=void 0,this._adapter=t.adapter,this._mode=new ye;const e=Object.keys(t.modes);if(e.length===0)throw new Error("No modes provided");e.forEach(l=>{if(t.modes[l].type===b.Select){if(this._instanceSelectMode)throw new Error("only one type of select mode can be provided");this._instanceSelectMode=l}}),this._modes=y({},t.modes,{static:this._mode}),this._eventListeners={change:[],select:[],deselect:[],finish:[]},this._store=new Ce;const i=l=>{const h=[],c=this._store.copyAll().filter(d=>!l.includes(d.id)||(h.push(d),!1));return{changed:h,unchanged:c}},n=l=>{this._enabled&&this._eventListeners.finish.forEach(h=>{h(l)})},o=(l,h)=>{if(!this._enabled)return;this._eventListeners.change.forEach(g=>{g(l,h)});const{changed:c,unchanged:d}=i(l);h==="create"?this._adapter.render({created:c,deletedIds:[],unchanged:d,updated:[]},this.getModeStyles()):h==="update"?this._adapter.render({created:[],deletedIds:[],unchanged:d,updated:c},this.getModeStyles()):h==="delete"?this._adapter.render({created:[],deletedIds:l,unchanged:d,updated:[]},this.getModeStyles()):h==="styling"&&this._adapter.render({created:[],deletedIds:[],unchanged:d,updated:[]},this.getModeStyles())},r=l=>{if(!this._enabled)return;this._eventListeners.select.forEach(d=>{d(l)});const{changed:h,unchanged:c}=i([l]);this._adapter.render({created:[],deletedIds:[],unchanged:c,updated:h},this.getModeStyles())},a=l=>{if(!this._enabled)return;this._eventListeners.deselect.forEach(d=>{d()});const{changed:h,unchanged:c}=i([l]);h&&this._adapter.render({created:[],deletedIds:[],unchanged:c,updated:h},this.getModeStyles())};Object.keys(this._modes).forEach(l=>{this._modes[l].register({mode:l,store:this._store,setCursor:this._adapter.setCursor.bind(this._adapter),project:this._adapter.project.bind(this._adapter),unproject:this._adapter.unproject.bind(this._adapter),setDoubleClickToZoom:this._adapter.setDoubleClickToZoom.bind(this._adapter),onChange:o,onSelect:r,onDeselect:a,onFinish:n})})}checkEnabled(){if(!this._enabled)throw new Error("Terra Draw is not enabled")}getModeStyles(){const t={};return Object.keys(this._modes).forEach(e=>{t[e]=i=>this._instanceSelectMode&&i.properties[ot]?this._modes[this._instanceSelectMode].styleFeature.bind(this._modes[this._instanceSelectMode])(i):this._modes[e].styleFeature.bind(this._modes[e])(i)}),t}setModeStyles(t,e){if(this.checkEnabled(),!this._modes[t])throw new Error("No mode with this name present");this._modes[t].styles=e}getSnapshot(){return this._store.copyAll()}clear(){this.checkEnabled(),this._adapter.clear()}get enabled(){return this._enabled}set enabled(t){throw new Error("Enabled is read only")}getMode(){return this._mode.mode}setMode(t){if(this.checkEnabled(),!this._modes[t])throw new Error("No mode with this name present");this._mode.stop(),this._mode=this._modes[t],this._mode.start()}removeFeatures(t){this.checkEnabled(),this._store.delete(t)}addFeatures(t){this.checkEnabled(),t.length!==0&&this._store.load(t,e=>{if(e&&typeof e=="object"&&"properties"in e&&typeof e.properties=="object"&&e.properties!==null&&"mode"in e.properties){const i=this._modes[e.properties.mode];return!!i&&i.validateFeature.bind(i)(e)}return!1})}start(){this._enabled=!0,this._adapter.register({getState:()=>this._mode.state,onClick:t=>{this._mode.onClick(t)},onMouseMove:t=>{this._mode.onMouseMove(t)},onKeyDown:t=>{this._mode.onKeyDown(t)},onKeyUp:t=>{this._mode.onKeyUp(t)},onDragStart:(t,e)=>{this._mode.onDragStart(t,e)},onDrag:(t,e)=>{this._mode.onDrag(t,e)},onDragEnd:(t,e)=>{this._mode.onDragEnd(t,e)},onClear:()=>{this._mode.cleanUp(),this._store.clear()}})}stop(){this._enabled=!1,this._adapter.unregister()}on(t,e){const i=this._eventListeners[t];i.includes(e)||i.push(e)}off(t,e){const i=this._eventListeners[t];i.includes(e)&&i.splice(i.indexOf(e),1)}}const Me=(s,t,e)=>{var i;window.draw=new xe({adapter:new Nt({map:window.map,coordinatePrecision:9}),modes:{select:new pe({flags:{polygon:{feature:{draggable:!0,rotateable:!0,scaleable:!0,coordinates:{midpoints:!0,draggable:!0,deletable:!0}}},circle:{feature:{draggable:!0,rotateable:!0,scaleable:!0,coordinates:{midpoints:!0,draggable:!0,deletable:!0}}}}}),polygon:new se({snapping:!1,allowSelfIntersections:!0}),circle:new te({})}}),(i=window.draw)==null||i.start(),window.draw.on("finish",()=>{const n=window.draw.getSnapshot();e&&e(n)})};export{Se as _hW,Me as s_02EzPjgYHuQ};
